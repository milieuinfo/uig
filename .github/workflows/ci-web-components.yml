name: ci-web-components

on:
  push:
    paths:
      - .github/workflows/ci-web-components.yml
      - web-components/**

env:
  CYPRESS_CACHE_FOLDER: cypress/cache

jobs:
  checkout-install-and-cache:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./web-components
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'
          cache-dependency-path: web-components/package-lock.json
      - name: authenticate to acd-npm repository
        run: |
          echo "registry=https://repo.omgeving.vlaanderen.be/artifactory/api/npm/acd-npm/"  > ~/.npmrc
          echo "//repo.omgeving.vlaanderen.be/artifactory/api/npm/acd-npm/:_authToken=${{ secrets.NPM_TOKEN_DOMG_ACD_NPM }}" >> ~/.npmrc
      - name: get package version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@main
        with:
          path: ./web-components
      - name: npm ci
        run: npm ci
        continue-on-error: false
      - name: cache workspace
        id: cache-workspace
        uses: actions/cache@v3
        env:
          cache-name: cache-workspace
        with:
          path: |
            ./web-components
            cypress/cache
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ github.run_number }}

  perform-all-unit-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./web-components
    needs: checkout-install-and-cache
    steps:
      - name: restore workspace cache
        id: cache-workspace
        uses: actions/cache@v3
        env:
          cache-name: cache-workspace
        with:
          path: |
            ./web-components
            cypress/cache
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ github.run_number }}
      - name: web-components - test
        run: npx nx test
        continue-on-error: false

  build-apps-and-libraries:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./web-components
    needs: checkout-install-and-cache
    steps:
      - name: restore workspace cache
        id: cache-workspace
        uses: actions/cache@v3
        env:
          cache-name: cache-workspace
        with:
          path: |
            ./web-components
            cypress/cache
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ github.run_number }}
      - name: web-components - build apps
        run: npx nx build
      - name: web-components - build libraries
        run: npm run build:all
      - name: archive app and lib artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist-build-apps-and-libraries
          path: dist
          retention-days: 1

  build-storybook:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./web-components
    needs: checkout-install-and-cache
    steps:
      - name: restore workspace cache
        id: cache-workspace
        uses: actions/cache@v3
        env:
          cache-name: cache-workspace
        with:
          path: |
            ./web-components
            cypress/cache
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ github.run_number }}
      - name: storybook - build
        run: npx nx build-storybook storybook
      - name: archive app and lib artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist-build-storybook
          path: dist
          retention-days: 1

  e2e-test-storybook:
    runs-on: ubuntu-latest
#    strategy:
#      matrix:
#        job: [0, 1, 2, 3]
    defaults:
      run:
        shell: bash
        working-directory: ./web-components
    needs: build-storybook
    steps:
      - name: restore workspace cache
        id: cache-workspace
        uses: actions/cache@v3
        env:
          cache-name: cache-workspace
        with:
          path: |
            ./web-components
            cypress/cache
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ github.run_number }}
      - name: storybook - e2e-test
        run: |
          npm run storybook:ci-test
          mkdir dist/cypress/apps/storybook-e2e/mochawesome
          npx mochawesome-merge dist/cypress/apps/storybook-e2e/mochawesome-reports/*.json > dist/cypress/apps/storybook-e2e/mochawesome/output.json
          npx marge dist/cypress/apps/storybook-e2e/mochawesome/output.json --reportDir dist/cypress/apps/storybook-e2e/mochawesome --inline --reportFilename index.html --reportPageTitle "Storybook e2e tests" --reportTitle "UIG Webcomponents - Storybook e2e tests"

  publish-dist-folder:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./web-components
    needs: [perform-all-unit-tests, build-apps-and-libraries, build-storybook, e2e-test-storybook]
    steps:
      - name: restore workspace cache
        id: cache-workspace
        uses: actions/cache@v3
        env:
          cache-name: cache-workspace
        with:
          path: |
            ./web-components
            cypress/cache
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ github.run_number }}
      - name: download app and lib artifacts
        uses: actions/download-artifact@v3
#        with:
#          name: |
#            dist-build-apps-and-libraries
#            dist-build-storybook
      - name: output the build result path
        run: echo "the build result (dist folder) is available at build-bamboo/web-components/${{ github.ref_name }}/${{ github.run_number }}"
#      - name: publish dist folder on github-pages
#        uses: JamesIves/github-pages-deploy-action@v4
#        with:
#          folder: web-components/dist
#          repository-name: milieuinfo/uig-pages
#          branch: main
#          target-folder: build-bamboo/${{ github.ref_name }}/web-components/${{ github.run_number }}
#          token: ${{ secrets.PAT_UIG_PAGES }}
      - name: publish Exhibit on github-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist-build-apps-and-libraries/apps/exhibit
          repository-name: milieuinfo/uig-pages
          branch: main
          target-folder: /build-apps/${{ github.ref_name }}/${{ steps.package-version.outputs.current-version}}/exhibit
          token: ${{ secrets.PAT_UIG_PAGES }}
      - name: publish Storybook on github-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist-build-storybook/apps/storybook
          repository-name: milieuinfo/uig-pages
          branch: main
          target-folder: /build-apps/${{ github.ref_name }}/${{ steps.package-version.outputs.current-version}}/storybook
          token: ${{ secrets.PAT_UIG_PAGES }}
      - name: publish documentation on github-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: documentation
          repository-name: milieuinfo/uig-pages
          branch: main
          target-folder: /build-apps/${{ github.ref_name }}/${{ steps.package-version.outputs.current-version}}/documentation
          token: ${{ secrets.PAT_UIG_PAGES }}


#      - name: authenticate to local-npm repository
#        run: |
#          echo "registry=https://repo.omgeving.vlaanderen.be/artifactory/api/npm/local-npm/"  > ~/.npmrc
#          echo "//repo.omgeving.vlaanderen.be/artifactory/api/npm/local-npm/:_authToken=${{ secrets.NPM_TOKEN_DOMG }}" > ~/.npmrc
#      - name: web-components - release all
#        run: npm run release:all
